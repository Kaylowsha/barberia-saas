<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberÃ­a SaaS - Sistema de GestiÃ³n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ConfiguraciÃ³n -->
<script src="config.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para Resumen */
.resumen-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.fecha-rango {
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
}

.resumen-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.desglose-pago {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.desglose-pago h4 {
    font-size: 16px;
    margin-bottom: 10px;
}

.desglose-pago ul {
    list-style: none;
    padding: 0;
}

.desglose-pago li {
    padding: 8px 0;
    font-size: 14px;
}
    </style>
</head>
<body class="bg-gray-50">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-cut text-6xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">BarberÃ­a SaaS</h1>
                <p class="text-gray-600 mt-2">Sistema de GestiÃ³n Profesional</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="tu@email.com"
                        required
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>ContraseÃ±a
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar SesiÃ³n
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="loginErrorText"></span>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Â¿Primera vez? Contacta al administrador</p>
            </div>
        </div>
    </div>
    
    <!-- Pantalla Principal (oculta inicialmente) -->
    <div id="mainApp" class="hidden">
        <!-- Barra de NavegaciÃ³n -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-cut text-2xl text-blue-600 mr-3"></i>
                        <span class="font-bold text-xl">BarberÃ­a SaaS</span>
                        <span id="barberiaName" class="ml-4 text-gray-600"></span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span id="userName" class="text-gray-700"></span>
                        <span id="userRole" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Alerta de Trial -->
        <div id="trialAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-700 mr-3"></i>
                <p id="trialMessage" class="text-yellow-700"></p>
            </div>
        </div>
        
        <!-- Tabs de NavegaciÃ³n -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto py-2" id="tabContainer">
                    <!-- Los tabs se generarÃ¡n dinÃ¡micamente segÃºn el rol -->
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contentArea" class="bg-white rounded-lg shadow p-6">
                <!-- El contenido se cargarÃ¡ dinÃ¡micamente -->
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando...</p>
        </div>
    </div>
    
    <!-- Script Principal -->
    <script>
        // ===============================
        // CONFIGURACIÃ“N DE SUPABASE
        // ===============================
        const SUPABASE_URL = SUPABASE_CONFIG.url;
const SUPABASE_ANON_KEY = SUPABASE_CONFIG.anonKey;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentUser = null;
        let currentBarberia = null;
        let userRole = null;
        
     // ===============================
// FUNCIONES DE AUTENTICACIÃ“N
// ===============================
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    showLoading();
    hideError();
    
    try {
        // LOGIN TEMPORAL - Sin verificaciÃ³n real
        // Simulamos los datos del usuario basado en el email
        let userData = null;
        
        if (email === 'israelparancan.n@gmail.com') {
            userData = {
                id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c',
                email: email,
                nombre: 'Administrador',
                role: 'admin',
                barberia_id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                barberias: {
                    id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                    nombre: 'NatWin',
                    plan: 'trial'
                }
            };
        } else if (email === 'ispn4trade@gmail.com') {
            userData = {
                id: '1a0242b8-bc7a-4e61-9e33-ac182996a950',
                email: email,
                nombre: 'Misho',
                role: 'empleado',
                barberia_id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                barberias: {
                    id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                    nombre: 'NatWin',
                    plan: 'trial'
                }
            };
        } else {
            showError('Usuario no encontrado. Usa uno de los emails de prueba.');
            hideLoading();
            return;
        }
        
        // Login exitoso
        currentUser = userData;
        currentBarberia = userData.barberias;
        userRole = userData.role;
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('userRole', userRole);
        
        initializeApp();
        
    } catch (error) {
        console.error('Error:', error);
        showError('Error al iniciar sesiÃ³n. Intenta nuevamente.');
    }
    
    hideLoading();
});
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }
        
        // ===============================
        // INICIALIZACIÃ“N DE LA APP
        // ===============================
        function initializeApp() {
            // Ocultar login, mostrar app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Actualizar informaciÃ³n del usuario
            document.getElementById('userName').textContent = currentUser.nombre;
            document.getElementById('userRole').textContent = userRole === 'admin' ? 'Administrador' : 'Empleado';
            document.getElementById('barberiaName').textContent = currentBarberia ? currentBarberia.nombre : '';
            
            // Verificar y mostrar alerta de trial si aplica
            checkTrialStatus();
            
            // Generar tabs segÃºn el rol
            generateTabs();
            
            // Cargar la primera pestaÃ±a
            loadTab('registrar');
        }
        
        async function checkTrialStatus() {
            // Temporalmente deshabilitado hasta configurar auth
    /*
            if (!currentBarberia) return;
            
            const { data: trialStatus } = await supabase
                .rpc('verificar_estado_trial', { 
                    p_barberia_id: currentBarberia.id 
                });
            
            if (trialStatus && trialStatus[0].plan === 'trial') {
                const dias = trialStatus[0].dias_restantes;
                document.getElementById('trialAlert').classList.remove('hidden');
                document.getElementById('trialMessage').textContent = 
                    `PerÃ­odo de prueba: ${dias} dÃ­as restantes. Contacta al administrador para continuar.`;
            }
            */
             // Mostrar mensaje temporal
    if (currentBarberia && currentBarberia.plan === 'trial') {
        document.getElementById('trialAlert').classList.remove('hidden');
        document.getElementById('trialMessage').textContent = 
            `PerÃ­odo de prueba activo. 15 dÃ­as restantes.`;
    }
        } 
        
        // ===============================
        // GENERACIÃ“N DE TABS
        // ===============================
        function generateTabs() {
            const tabContainer = document.getElementById('tabContainer');
            const tabs = [];
            
            // Tabs comunes para todos
            tabs.push(
                { id: 'registrar', label: 'Registrar Servicio', icon: 'fa-plus-circle' },
                { id: 'resumen', label: 'Resumen', icon: 'fa-chart-bar' },
                { id: 'servicios', label: 'Servicios', icon: 'fa-list' }
            );
            
            // Tabs exclusivos del admin
            if (userRole === 'admin') {
                tabs.push(
                    { id: 'barberos', label: 'GestiÃ³n Barberos', icon: 'fa-users' },
                    { id: 'cierre', label: 'Cierre de Caja', icon: 'fa-cash-register' },
                    { id: 'estadisticas', label: 'EstadÃ­sticas', icon: 'fa-chart-line' }
                );
            }
            
            // Generar HTML de tabs
            tabContainer.innerHTML = tabs.map(tab => `
                <button 
                    onclick="loadTab('${tab.id}')"
                    id="tab-${tab.id}"
                    class="px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:text-blue-600 hover:bg-gray-50 transition-colors tab-button"
                >
                    <i class="fas ${tab.icon} mr-2"></i>${tab.label}
                </button>
            `).join('');
        }
        
        // ===============================
        // NAVEGACIÃ“N ENTRE TABS
        // ===============================
        function loadTab(tabId) {
            // Actualizar estado visual de tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600');
                activeTab.classList.add('bg-blue-600', 'text-white');
            }
            
            // Cargar contenido segÃºn el tab
            const contentArea = document.getElementById('contentArea');
            
            switch(tabId) {
                case 'registrar':
                    loadRegistrarServicio();
                    break;
                case 'resumen':
                    loadResumen();
                    break;
                case 'servicios':
                    loadServicios();
                    break;
                case 'barberos':
                    loadGestionBarberos();
                    break;
                case 'cierre':
                    loadCierreCaja();
                    break;
                case 'estadisticas':
                    loadEstadisticas();
                    break;
                default:
                    contentArea.innerHTML = '<p>SecciÃ³n en desarrollo...</p>';
            }
        }
        
        // ===============================
        // CONTENIDO DE CADA TAB
        // ===============================
        function loadRegistrarServicio() {
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-plus-circle mr-2"></i>Registrar Nuevo Servicio
                    </h2>
                    
                    <form id="registroForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Servicio Principal *
                            </label>
                            <select id="servicioPrincipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Selecciona un servicio...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Servicio Adicional (opcional)
                            </label>
                            <select id="servicioAdicional" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Monto Cobrado *
                            </label>
                            <input type="number" id="monto" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="$" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Forma de Pago *
                            </label>
                            <select id="formaPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Selecciona...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Cuenta RUT">Cuenta RUT</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Notas (opcional)
                            </label>
                            <textarea id="notas" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Registrar Servicio
                        </button>
                    </form>
                </div>
            `;
            
            // Cargar servicios disponibles
            loadServiciosDropdown();
            
            // Agregar evento al formulario
            document.getElementById('registroForm').addEventListener('submit', registrarServicio);
        }
        
        async function loadServiciosDropdown() {
    // Temporalmente usar servicios hardcodeados
    const servicios = [
        { id: 1, nombre: 'Corte Tradicional - Estudiante', precio_sugerido: 12000 },
        { id: 2, nombre: 'Corte Tijera', precio_sugerido: 15000 },
        { id: 3, nombre: 'Fade - Degradados', precio_sugerido: 18000 },
        { id: 4, nombre: 'Barba Rasurado', precio_sugerido: 8000 },
        { id: 5, nombre: 'Perfilado Barba', precio_sugerido: 10000 },
        { id: 6, nombre: 'Barba Premium', precio_sugerido: 12000 },
        { id: 7, nombre: 'Rasurado de Barba con Vapor', precio_sugerido: 15000 },
        { id: 8, nombre: 'Limpieza Facial Premium', precio_sugerido: 20000 },
        { id: 9, nombre: 'Servicio Full', precio_sugerido: 35000 },
        { id: 10, nombre: 'Cejas', precio_sugerido: 5000 },
        { id: 11, nombre: 'DiseÃ±os', precio_sugerido: 8000 },
        { id: 12, nombre: 'LÃ­neas', precio_sugerido: 5000 }
    ];
    
    const options = servicios.map(s => 
        `<option value="${s.id}" data-precio="${s.precio_sugerido}">${s.nombre}</option>`
    ).join('');
    
    document.getElementById('servicioPrincipal').innerHTML += options;
    document.getElementById('servicioAdicional').innerHTML += options;
}
        
        async function registrarServicio(e) {
    e.preventDefault();
    
    showLoading();
    
    const servicioPrincipal = document.getElementById('servicioPrincipal');
    const servicioAdicional = document.getElementById('servicioAdicional');
    const monto = document.getElementById('monto').value;
    const formaPago = document.getElementById('formaPago').value;
    const notas = document.getElementById('notas').value;
    
    // Validaciones
    if (!servicioPrincipal.value || !monto || !formaPago) {
        alert('Por favor completa todos los campos obligatorios');
        hideLoading();
        return;
    }
    
    try {
        // Para desarrollo, guardamos directamente sin auth
        const nuevoServicio = {
            barberia_id: SUPABASE_CONFIG.barberiaId,
            realizado_por_id: currentUser.id,
            realizado_por_nombre: currentUser.nombre,
            servicio_principal_id: parseInt(servicioPrincipal.value),
            servicio_principal_nombre: servicioPrincipal.options[servicioPrincipal.selectedIndex].text,
            servicio_adicional_id: servicioAdicional.value ? parseInt(servicioAdicional.value) : null,
            servicio_adicional_nombre: servicioAdicional.value ? servicioAdicional.options[servicioAdicional.selectedIndex].text : null,
            monto_total: parseFloat(monto),
            forma_pago: formaPago,
            notas: notas || null,
            fecha: new Date().toISOString().split('T')[0]
        };
        
        console.log('Guardando servicio:', nuevoServicio);
        
        const { data, error } = await supabase
            .from('citas')
            .insert([nuevoServicio])
            .select();
        
        if (error) {
            console.error('Error de Supabase:', error);
            alert('Error al guardar: ' + error.message);
        } else {
            alert('âœ… Servicio registrado exitosamente! CÃ³digo: #' + (data[0].codigo_diario || data[0].id));
            document.getElementById('registroForm').reset();
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al registrar el servicio: ' + error.message);
    }
    
    hideLoading();
}
            
       
        
        function loadResumen() {
         <div id="resumen" class="tab-content">
    <h2>ðŸ“Š Resumen</h2>
    
    <!-- Selector de Vista -->
    <div class="form-group">
        <label>Seleccionar Vista:</label>
        <select id="vistaResumen" class="form-control" onchange="cambiarVistaResumen()">
            <option value="diaria">Vista Diaria</option>
            <option value="semanal">Vista Semanal</option>
            <option value="mensual">Vista Mensual</option>
        </select>
    </div>

    <!-- Filtro de Barbero (solo para admin) -->
    <div id="filtroBarberoResumen" class="form-group" style="display:none;">
        <label>Filtrar por Barbero:</label>
        <select id="selectBarberoResumen" class="form-control" onchange="cargarResumen()">
            <option value="todos">Ver Todos</option>
            <option value="mi">Mi Resumen</option>
        </select>
    </div>

    <!-- Selector de Fecha -->
    <div class="form-group">
        <label id="labelFechaResumen">Fecha:</label>
        <input type="date" id="fechaResumen" class="form-control" onchange="cargarResumen()">
    </div>

    <!-- Contenedor del Resumen -->
    <div id="contenidoResumen" style="margin-top: 20px;">
        <div class="loading">Cargando resumen...</div>
    </div>
</div>
        
      // FunciÃ³n para cargar resumen
async function loadResumen() {
    console.log('Cargando resumen...');
    
    // Configurar fecha inicial
    document.getElementById('fechaResumen').value = new Date().toISOString().split('T')[0];
    
    // Si es admin, mostrar filtro de barberos
    if (currentUser.role === 'admin') {
        document.getElementById('filtroBarberoResumen').style.display = 'block';
        await cargarBarberosEnFiltro();
    }
    
    // Cargar datos del resumen
    await cargarResumen();
}

// FunciÃ³n para cambiar vista del resumen
function cambiarVistaResumen() {
    const vista = document.getElementById('vistaResumen').value;
    const labelFecha = document.getElementById('labelFechaResumen');
    const inputFecha = document.getElementById('fechaResumen');
    
    switch(vista) {
        case 'diaria':
            labelFecha.textContent = 'Fecha:';
            inputFecha.type = 'date';
            break;
        case 'semanal':
            labelFecha.textContent = 'Seleccionar cualquier dÃ­a de la semana:';
            inputFecha.type = 'date';
            break;
        case 'mensual':
            labelFecha.textContent = 'Seleccionar mes:';
            inputFecha.type = 'month';
            break;
    }
    
    cargarResumen();
}

// FunciÃ³n para cargar barberos en el filtro
async function cargarBarberosEnFiltro() {
    try {
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', BARBERIA_ID)
            .eq('activo', true);
        
        if (error) throw error;
        
        const select = document.getElementById('selectBarberoResumen');
        
        // Mantener las primeras dos opciones y agregar los barberos
        select.innerHTML = `
            <option value="todos">Ver Todos</option>
            <option value="mi">Mi Resumen</option>
        `;
        
        barberos.forEach(barbero => {
            const option = document.createElement('option');
            option.value = barbero.id;
            option.textContent = barbero.nombre;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando barberos:', error);
    }
}

// FunciÃ³n principal para cargar datos del resumen
async function cargarResumen() {
    const contenido = document.getElementById('contenidoResumen');
    contenido.innerHTML = '<div class="loading">Calculando resumen...</div>';
    
    try {
        const vista = document.getElementById('vistaResumen').value;
        const fecha = document.getElementById('fechaResumen').value;
        const filtro = document.getElementById('selectBarberoResumen')?.value || 'mi';
        
        if (!fecha) {
            contenido.innerHTML = '<p>Por favor selecciona una fecha</p>';
            return;
        }
        
        let fechaInicio, fechaFin;
        
        // Calcular rango de fechas segÃºn la vista
        if (vista === 'diaria') {
            fechaInicio = fecha;
            fechaFin = fecha;
        } else if (vista === 'semanal') {
            const date = new Date(fecha);
            const dayOfWeek = date.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Ajustar para que lunes sea el inicio
            
            const lunes = new Date(date);
            lunes.setDate(date.getDate() - diff);
            
            const domingo = new Date(lunes);
            domingo.setDate(lunes.getDate() + 6);
            
            fechaInicio = lunes.toISOString().split('T')[0];
            fechaFin = domingo.toISOString().split('T')[0];
        } else if (vista === 'mensual') {
            const [year, month] = fecha.split('-');
            fechaInicio = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            fechaFin = `${year}-${month}-${lastDay.toString().padStart(2, '0')}`;
        }
        
        // Construir query base
        let query = supabase
            .from('citas')
            .select('*')
            .eq('barberia_id', BARBERIA_ID)
            .gte('created_at', fechaInicio + 'T00:00:00')
            .lte('created_at', fechaFin + 'T23:59:59');
        
        // Aplicar filtro segÃºn rol y selecciÃ³n
        if (currentUser.role === 'empleado') {
            query = query.eq('realizado_por_id', currentUser.id);
        } else if (currentUser.role === 'admin' && filtro !== 'todos') {
            if (filtro === 'mi') {
                query = query.eq('realizado_por_id', currentUser.id);
            } else {
                query = query.eq('realizado_por_id', filtro);
            }
        }
        
        const { data: servicios, error } = await query;
        
        if (error) throw error;
        
        // Calcular totales
        const totalRecaudado = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
        const totalServicios = servicios.length;
        
        // Agrupar por forma de pago
        const porFormaPago = servicios.reduce((acc, s) => {
            acc[s.forma_pago] = (acc[s.forma_pago] || 0) + parseFloat(s.monto_total || 0);
            return acc;
        }, {});
        
        // Obtener adelantos si es vista semanal o mensual
        let totalAdelantos = 0;
        if (vista !== 'diaria') {
            const { data: adelantos } = await supabase
                .from('adelantos')
                .select('monto')
                .eq('barberia_id', BARBERIA_ID)
                .eq('activo', true)
                .gte('created_at', fechaInicio + 'T00:00:00')
                .lte('created_at', fechaFin + 'T23:59:59');
            
            if (adelantos) {
                totalAdelantos = adelantos.reduce((sum, a) => sum + parseFloat(a.monto || 0), 0);
            }
        }
        
        // Mostrar resumen
        let html = `
            <div class="resumen-card">
                <h3>ðŸ“… Resumen ${vista === 'diaria' ? 'del DÃ­a' : vista === 'semanal' ? 'Semanal' : 'Mensual'}</h3>
                <p class="fecha-rango">${fechaInicio === fechaFin ? fechaInicio : fechaInicio + ' al ' + fechaFin}</p>
                
                <div class="resumen-stats">
                    <div class="stat-item">
                        <div class="stat-label">ðŸ’° Total Recaudado</div>
                        <div class="stat-value">$${totalRecaudado.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-label">ðŸ“Š Servicios Realizados</div>
                        <div class="stat-value">${totalServicios}</div>
                    </div>
        `;
        
        if (vista !== 'diaria' && totalAdelantos > 0) {
            html += `
                    <div class="stat-item">
                        <div class="stat-label">ðŸ’¸ Adelantos</div>
                        <div class="stat-value">$${totalAdelantos.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-label">ðŸ’° Total Neto</div>
                        <div class="stat-value" style="color: #4CAF50; font-weight: bold;">
                            $${(totalRecaudado - totalAdelantos).toLocaleString('es-CL')}
                        </div>
                    </div>
            `;
        }
        
        html += `
                </div>
                
                <div class="desglose-pago">
                    <h4>ðŸ’³ Desglose por Forma de Pago</h4>
                    <ul>
                        <li>ðŸ’µ Efectivo: $${(porFormaPago['Efectivo'] || 0).toLocaleString('es-CL')}</li>
                        <li>ðŸ’³ Cuenta RUT: $${(porFormaPago['Cuenta RUT'] || 0).toLocaleString('es-CL')}</li>
                        <li>ðŸ“± Mercado Pago: $${(porFormaPago['Mercado Pago'] || 0).toLocaleString('es-CL')}</li>
                    </ul>
                </div>
            </div>
        `;
        
        contenido.innerHTML = html;
        
    } catch (error) {
        console.error('Error:', error);
        contenido.innerHTML = '<div class="error">Error al cargar el resumen</div>';
    }
}
    try {
        // Obtener servicios de hoy
        const hoy = new Date().toISOString().split('T')[0];
        // Filtrar segÃºn el rol
let query = supabase
    .from('citas')
    .select('*')
    .eq('barberia_id', SUPABASE_CONFIG.barberiaId)
    .eq('fecha', hoy);

// Si es empleado, solo ver SUS servicios
if (userRole === 'empleado') {
    query = query.eq('realizado_por_id', currentUser.id);
}

const { data, error } = await query.order('codigo_diario', { ascending: false });
        
        if (error) throw error;
        
        const listaHTML = data && data.length > 0 ? 
            `<div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">CÃ³digo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Barbero</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pago</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.map(s => `
                            <tr>
                                <td class="px-4 py-2 text-sm">#${s.codigo_diario}</td>
                                <td class="px-4 py-2 text-sm">${s.realizado_por_nombre}</td>
                                <td class="px-4 py-2 text-sm">${s.servicio_principal_nombre}</td>
                                <td class="px-4 py-2 text-sm font-semibold">$${s.monto_total.toLocaleString('es-CL')}</td>
                                <td class="px-4 py-2 text-sm">${s.forma_pago}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>` 
            : '<p class="text-gray-500">No hay servicios registrados hoy.</p>';
        
        document.getElementById('serviciosLista').innerHTML = listaHTML;
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('serviciosLista').innerHTML = 
            '<p class="text-red-600">Error al cargar servicios</p>';
    }
}
        
        function loadGestionBarberos() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secciÃ³n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-users mr-2"></i>GestiÃ³n de Barberos
                </h2>
                <p class="text-gray-600">Administra los barberos y adelantos...</p>
                <!-- AquÃ­ irÃ­a el contenido de gestiÃ³n -->
            `;
        }
        
        function loadCierreCaja() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secciÃ³n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-cash-register mr-2"></i>Cierre de Caja
                </h2>
                <p class="text-gray-600">Realiza el cierre de caja...</p>
                <!-- AquÃ­ irÃ­a el contenido del cierre -->
            `;
        }
        
        function loadEstadisticas() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secciÃ³n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-chart-line mr-2"></i>EstadÃ­sticas
                </h2>
                <p class="text-gray-600">Visualiza las estadÃ­sticas del negocio...</p>
                <!-- AquÃ­ irÃ­an los grÃ¡ficos y estadÃ­sticas -->
            `;
        }
        
        // ===============================
        // LOGOUT
        // ===============================
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            location.reload();
        }
        
        // ===============================
        // VERIFICAR SESIÃ“N AL CARGAR
        // ===============================
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userRole = localStorage.getItem('userRole');
                
                // AquÃ­ deberÃ­as verificar que el usuario sigue siendo vÃ¡lido
                // Por ahora, simplemente inicializamos la app
                initializeApp();
            }
        });
    </script>
</body>
</html>
