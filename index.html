<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber√≠a SaaS - Sistema de Gesti√≥n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuraci√≥n -->
    <script src="config.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-cut text-6xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">Barber√≠a SaaS</h1>
                <p class="text-gray-600 mt-2">Sistema de Gesti√≥n Profesional</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="tu@email.com"
                        required
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Contrase√±a
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="loginErrorText"></span>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>¬øPrimera vez? Contacta al administrador</p>
            </div>
        </div>
    </div>
    
    <!-- Pantalla Principal (oculta inicialmente) -->
    <div id="mainApp" class="hidden">
        <!-- Barra de Navegaci√≥n -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-cut text-2xl text-blue-600 mr-3"></i>
                        <span class="font-bold text-xl">Barber√≠a SaaS</span>
                        <span id="barberiaName" class="ml-4 text-gray-600"></span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span id="userName" class="text-gray-700"></span>
                        <span id="userRole" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Alerta de Trial -->
        <div id="trialAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-700 mr-3"></i>
                <p id="trialMessage" class="text-yellow-700"></p>
            </div>
        </div>
        
        <!-- Tabs de Navegaci√≥n -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto py-2" id="tabContainer">
                    <!-- Los tabs se generar√°n din√°micamente seg√∫n el rol -->
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contentArea" class="bg-white rounded-lg shadow p-6">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando...</p>
        </div>
    </div>
    
    <!-- Script Principal -->
    <script>
        // ===============================
        // CONFIGURACI√ìN DE SUPABASE
        // ===============================
        const SUPABASE_URL = SUPABASE_CONFIG.url;
        const SUPABASE_ANON_KEY = SUPABASE_CONFIG.anonKey;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentUser = null;
        let currentBarberia = null;
        let userRole = null;
        
        // ===============================
        // FUNCIONES DE AUTENTICACI√ìN
        // ===============================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading();
            hideError();
            
            try {
                // LOGIN TEMPORAL - Sin verificaci√≥n real
                let userData = null;
                
                if (email === 'israelparancan.n@gmail.com') {
                    userData = {
                        id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c',
                        email: email,
                        nombre: 'Administrador',
                        role: 'admin',
                        barberia_id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                        barberias: {
                            id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                            nombre: 'NatWin',
                            plan: 'trial'
                        }
                    };
                } else if (email === 'ispn4trade@gmail.com') {
                    userData = {
                        id: '1a0242b8-bc7a-4e61-9e33-ac182996a950',
                        email: email,
                        nombre: 'Misho',
                        role: 'empleado',
                        barberia_id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                        barberias: {
                            id: '79da96ae-4357-4ede-8c98-9a61c1c3378e',
                            nombre: 'NatWin',
                            plan: 'trial'
                        }
                    };
                } else {
                    showError('Usuario no encontrado. Usa uno de los emails de prueba.');
                    hideLoading();
                    return;
                }
                
                // Login exitoso
                currentUser = userData;
                currentBarberia = userData.barberias;
                userRole = userData.role;
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('userRole', userRole);
                
                initializeApp();
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error al iniciar sesi√≥n. Intenta nuevamente.');
            }
            
            hideLoading();
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }
        
        // ===============================
        // INICIALIZACI√ìN DE LA APP
        // ===============================
        function initializeApp() {
            // Ocultar login, mostrar app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Actualizar informaci√≥n del usuario
            document.getElementById('userName').textContent = currentUser.nombre;
            document.getElementById('userRole').textContent = userRole === 'admin' ? 'Administrador' : 'Empleado';
            document.getElementById('barberiaName').textContent = currentBarberia ? currentBarberia.nombre : '';
            
            // Verificar y mostrar alerta de trial si aplica
            checkTrialStatus();
            
            // Generar tabs seg√∫n el rol
            generateTabs();
            
            // Cargar la primera pesta√±a
            loadTab('registrar');
        }
        
        async function checkTrialStatus() {
            // Mostrar mensaje temporal
            if (currentBarberia && currentBarberia.plan === 'trial') {
                document.getElementById('trialAlert').classList.remove('hidden');
                document.getElementById('trialMessage').textContent = 
                    `Per√≠odo de prueba activo. 15 d√≠as restantes.`;
            }
        }
        
        // ===============================
        // GENERACI√ìN DE TABS
        // ===============================
        function generateTabs() {
            const tabContainer = document.getElementById('tabContainer');
            const tabs = [];
            
            // Tabs comunes para todos
            tabs.push(
                { id: 'registrar', label: 'Registrar Servicio', icon: 'fa-plus-circle' },
                { id: 'resumen', label: 'Resumen', icon: 'fa-chart-bar' },
                { id: 'servicios', label: 'Servicios', icon: 'fa-list' }
            );
            
            // Tabs exclusivos del admin
            if (userRole === 'admin') {
                tabs.push(
                    { id: 'barberos', label: 'Gesti√≥n Barberos', icon: 'fa-users' },
                    { id: 'cierre', label: 'Cierre de Caja', icon: 'fa-cash-register' },
                    { id: 'estadisticas', label: 'Estad√≠sticas', icon: 'fa-chart-line' }
                );
            }
            
            // Generar HTML de tabs
            tabContainer.innerHTML = tabs.map(tab => `
                <button 
                    onclick="loadTab('${tab.id}')"
                    id="tab-${tab.id}"
                    class="px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:text-blue-600 hover:bg-gray-50 transition-colors tab-button"
                >
                    <i class="fas ${tab.icon} mr-2"></i>${tab.label}
                </button>
            `).join('');
        }
        
        // ===============================
        // NAVEGACI√ìN ENTRE TABS
        // ===============================
        function loadTab(tabId) {
            // Actualizar estado visual de tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600');
                activeTab.classList.add('bg-blue-600', 'text-white');
            }
            
            // Cargar contenido seg√∫n el tab
            switch(tabId) {
                case 'registrar':
                    loadRegistrarServicio();
                    break;
                case 'resumen':
                    loadResumen();
                    break;
                case 'servicios':
                    loadServicios();
                    break;
                case 'barberos':
                    loadGestionBarberos();
                    break;
                case 'cierre':
                    loadCierreCaja();
                    break;
                case 'estadisticas':
                    loadEstadisticas();
                    break;
                default:
                    document.getElementById('contentArea').innerHTML = '<p>Secci√≥n en desarrollo...</p>';
            }
        }
        
        // ===============================
        // PESTA√ëA: REGISTRAR SERVICIO
        // ===============================
        function loadRegistrarServicio() {
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-plus-circle mr-2"></i>Registrar Nuevo Servicio
                    </h2>
                    
                    <form id="registroForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Servicio Principal *
                            </label>
                            <select id="servicioPrincipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Selecciona un servicio...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Servicio Adicional (opcional)
                            </label>
                            <select id="servicioAdicional" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Ninguno</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Monto Cobrado *
                            </label>
                            <input type="number" id="monto" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="$" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Forma de Pago *
                            </label>
                            <select id="formaPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Selecciona...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Cuenta RUT">Cuenta RUT</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Notas (opcional)
                            </label>
                            <textarea id="notas" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Registrar Servicio
                        </button>
                    </form>
                </div>
            `;
            
            // Cargar servicios disponibles
            loadServiciosDropdown();
            
            // Agregar evento al formulario
            document.getElementById('registroForm').addEventListener('submit', registrarServicio);
        }
        
        async function loadServiciosDropdown() {
            // Temporalmente usar servicios hardcodeados
            const servicios = [
                { id: 1, nombre: 'Corte Tradicional - Estudiante', precio_sugerido: 12000 },
                { id: 2, nombre: 'Corte Tijera', precio_sugerido: 15000 },
                { id: 3, nombre: 'Fade - Degradados', precio_sugerido: 18000 },
                { id: 4, nombre: 'Barba Rasurado', precio_sugerido: 8000 },
                { id: 5, nombre: 'Perfilado Barba', precio_sugerido: 10000 },
                { id: 6, nombre: 'Barba Premium', precio_sugerido: 12000 },
                { id: 7, nombre: 'Rasurado de Barba con Vapor', precio_sugerido: 15000 },
                { id: 8, nombre: 'Limpieza Facial Premium', precio_sugerido: 20000 },
                { id: 9, nombre: 'Servicio Full', precio_sugerido: 35000 },
                { id: 10, nombre: 'Cejas', precio_sugerido: 5000 },
                { id: 11, nombre: 'Dise√±os', precio_sugerido: 8000 },
                { id: 12, nombre: 'L√≠neas', precio_sugerido: 5000 }
            ];
            
            const options = servicios.map(s => 
                `<option value="${s.id}" data-precio="${s.precio_sugerido}">${s.nombre}</option>`
            ).join('');
            
            document.getElementById('servicioPrincipal').innerHTML += options;
            document.getElementById('servicioAdicional').innerHTML += options;
        }
        
        async function registrarServicio(e) {
            e.preventDefault();
            
            showLoading();
            
            const servicioPrincipal = document.getElementById('servicioPrincipal');
            const servicioAdicional = document.getElementById('servicioAdicional');
            const monto = document.getElementById('monto').value;
            const formaPago = document.getElementById('formaPago').value;
            const notas = document.getElementById('notas').value;
            
            // Validaciones
            if (!servicioPrincipal.value || !monto || !formaPago) {
                alert('Por favor completa todos los campos obligatorios');
                hideLoading();
                return;
            }
            
            try {
                const nuevoServicio = {
                    barberia_id: SUPABASE_CONFIG.barberiaId,
                    realizado_por_id: currentUser.id,
                    realizado_por_nombre: currentUser.nombre,
                    servicio_principal_id: parseInt(servicioPrincipal.value),
                    servicio_principal_nombre: servicioPrincipal.options[servicioPrincipal.selectedIndex].text,
                    servicio_adicional_id: servicioAdicional.value ? parseInt(servicioAdicional.value) : null,
                    servicio_adicional_nombre: servicioAdicional.value ? servicioAdicional.options[servicioAdicional.selectedIndex].text : null,
                    monto_total: parseFloat(monto),
                    forma_pago: formaPago,
                    notas: notas || null,
                    fecha: new Date().toISOString().split('T')[0]
                };
                
                console.log('Guardando servicio:', nuevoServicio);
                
                const { data, error } = await supabase
                    .from('citas')
                    .insert([nuevoServicio])
                    .select();
                
                if (error) {
                    console.error('Error de Supabase:', error);
                    alert('Error al guardar: ' + error.message);
                } else {
                    alert('‚úÖ Servicio registrado exitosamente! C√≥digo: #' + (data[0].codigo_diario || data[0].id));
                    document.getElementById('registroForm').reset();
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al registrar el servicio: ' + error.message);
            }
            
            hideLoading();
        }
        
        // ===============================
        // PESTA√ëA: RESUMEN
        // ===============================
        function loadResumen() {
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-chart-bar mr-2"></i>Resumen
                    </h2>
                    
                    <!-- Selector de Vista -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Vista:</label>
                        <select id="vistaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cambiarVistaResumen()">
                            <option value="diaria">Vista Diaria</option>
                            <option value="semanal">Vista Semanal</option>
                            <option value="mensual">Vista Mensual</option>
                        </select>
                    </div>

                    <!-- Filtro de Barbero (solo para admin) -->
                    <div id="filtroBarberoResumen" class="mb-4" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Barbero:</label>
                        <select id="selectBarberoResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
                            <option value="todos">Ver Todos</option>
                            <option value="mi">Mi Resumen</option>
                        </select>
                    </div>

                    <!-- Selector de Fecha -->
                    <div class="mb-4">
                        <label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                        <input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
                    </div>

                    <!-- Contenedor del Resumen -->
                    <div id="contenidoResumen" class="mt-6">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-600">Cargando resumen...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar fecha inicial
            document.getElementById('fechaResumen').value = new Date().toISOString().split('T')[0];
            
            // Si es admin, mostrar filtro de barberos
            if (userRole === 'admin') {
                document.getElementById('filtroBarberoResumen').style.display = 'block';
                cargarBarberosEnFiltro();
            }
            
            // Cargar datos del resumen
            cargarDatosResumen();
        }
        
       async function cargarDatosResumen() {
    const contenido = document.getElementById('contenidoResumen');
    if (!contenido) return;
    
    contenido.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Calculando resumen...</p></div>';
    
    try {
        const vista = document.getElementById('vistaResumen').value;
        const filtro = document.getElementById('selectBarberoResumen')?.value || 'mi';
        
        let fechaInicio, fechaFin, fecha;
        
        // Obtener fechas seg√∫n la vista actual
        if (vista === 'mensual') {
            fechaInicio = document.getElementById('fechaDesde')?.value;
            fechaFin = document.getElementById('fechaHasta')?.value;
            
            if (!fechaInicio || !fechaFin) {
                contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona ambas fechas del rango</p>';
                return;
            }
        } else {
            // Para diaria y semanal
            fecha = document.getElementById('fechaResumen')?.value;
            
            if (!fecha) {
                contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona una fecha</p>';
                return;
            }
            
            // Calcular rango seg√∫n la vista
            if (vista === 'diaria') {
                fechaInicio = fecha;
                fechaFin = fecha;
            } else if (vista === 'semanal') {
                const date = new Date(fecha + 'T00:00:00');
                const dayOfWeek = date.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const lunes = new Date(date);
                lunes.setDate(date.getDate() - diff);
                
                const domingo = new Date(lunes);
                domingo.setDate(lunes.getDate() + 6);
                
                fechaInicio = lunes.toISOString().split('T')[0];
                fechaFin = domingo.toISOString().split('T')[0];
            }
        }
        
        console.log(`üîç Cargando datos: ${vista} | ${fechaInicio} al ${fechaFin}`);
        
        // Construir query base
        let query = supabase
            .from('citas')
            .select('*')
            .eq('barberia_id', SUPABASE_CONFIG.barberiaId)
            .gte('fecha', fechaInicio)
            .lte('fecha', fechaFin);
        
        // Aplicar filtro seg√∫n rol y selecci√≥n
        if (userRole === 'empleado') {
            query = query.eq('realizado_por_id', currentUser.id);
        } else if (userRole === 'admin' && filtro !== 'todos') {
            if (filtro === 'mi') {
                query = query.eq('realizado_por_id', currentUser.id);
            } else {
                query = query.eq('realizado_por_id', filtro);
            }
        }
        
        const { data: servicios, error } = await query;
        
        if (error) throw error;
        
        // Calcular totales
        const totalRecaudado = servicios ? servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0) : 0;
        const totalServicios = servicios ? servicios.length : 0;
        
        // Agrupar por forma de pago
        const porFormaPago = servicios ? servicios.reduce((acc, s) => {
            acc[s.forma_pago] = (acc[s.forma_pago] || 0) + parseFloat(s.monto_total || 0);
            return acc;
        }, {}) : {};
        
        // Obtener adelantos si es vista semanal o mensual
        let totalAdelantos = 0;
        if (vista !== 'diaria' && userRole === 'admin') {
            const { data: adelantos } = await supabase
                .from('adelantos')
                .select('monto')
                .eq('barberia_id', SUPABASE_CONFIG.barberiaId)
                .eq('activo', true)
                .gte('created_at', fechaInicio + 'T00:00:00')
                .lte('created_at', fechaFin + 'T23:59:59');
            
            if (adelantos) {
                totalAdelantos = adelantos.reduce((sum, a) => sum + parseFloat(a.monto || 0), 0);
            }
        }
        
        // Mostrar resumen
        let html = `
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4">
                    üìÖ Resumen ${vista === 'diaria' ? 'del D√≠a' : vista === 'semanal' ? 'Semanal' : 'del Rango'}
                </h3>
                <p class="text-gray-600 mb-6">${fechaInicio === fechaFin ? fechaInicio : fechaInicio + ' al ' + fechaFin}</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-blue-600 mb-1">üí∞ Total Recaudado</div>
                        <div class="text-2xl font-bold text-blue-900">$${totalRecaudado.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-green-600 mb-1">üìä Servicios Realizados</div>
                        <div class="text-2xl font-bold text-green-900">${totalServicios}</div>
                    </div>
        `;
        
        if (vista !== 'diaria' && totalAdelantos > 0) {
            html += `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <div class="text-sm text-yellow-600 mb-1">üí∏ Adelantos</div>
                        <div class="text-2xl font-bold text-yellow-900">$${totalAdelantos.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-purple-600 mb-1">üí∞ Total Neto</div>
                        <div class="text-2xl font-bold text-purple-900">$${(totalRecaudado - totalAdelantos).toLocaleString('es-CL')}</div>
                    </div>
            `;
        }
        
        html += `
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-semibold mb-3">üí≥ Desglose por Forma de Pago</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>üíµ Efectivo:</span>
                            <span class="font-semibold">$${(porFormaPago['Efectivo'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üí≥ Cuenta RUT:</span>
                            <span class="font-semibold">$${(porFormaPago['Cuenta RUT'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üì± Mercado Pago:</span>
                            <span class="font-semibold">$${(porFormaPago['Mercado Pago'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        contenido.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        contenido.innerHTML = '<div class="bg-red-100 p-4 rounded-lg text-red-700">Error al cargar el resumen. Por favor intenta nuevamente.</div>';
    }
}
        
       function cambiarVistaResumen() {
    const vista = document.getElementById('vistaResumen').value;
    const labelFecha = document.getElementById('labelFechaResumen');
    const inputFecha = document.getElementById('fechaResumen');
    
    if (!labelFecha || !inputFecha) return;
    
    // Limpiar el contenedor de fecha
    const fechaContainer = inputFecha.parentElement;
    
    switch(vista) {
        case 'diaria':
            fechaContainer.innerHTML = `
                <label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                <input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
            `;
            document.getElementById('fechaResumen').value = new Date().toISOString().split('T')[0];
            break;
            
        case 'semanal':
            fechaContainer.innerHTML = `
                <label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar cualquier d√≠a de la semana:</label>
                <input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
            `;
            document.getElementById('fechaResumen').value = new Date().toISOString().split('T')[0];
            break;
            
        case 'mensual':
            fechaContainer.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-2">Rango de fechas:</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-600">Desde:</label>
                        <input type="date" id="fechaDesde" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">Hasta:</label>
                        <input type="date" id="fechaHasta" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
                    </div>
                </div>
            `;
            // Establecer primer y √∫ltimo d√≠a del mes actual
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('fechaDesde').value = firstDay.toISOString().split('T')[0];
            document.getElementById('fechaHasta').value = lastDay.toISOString().split('T')[0];
            break;
    }
    
    cargarDatosResumen();
}
        
      async function cargarBarberosEnFiltro() {
    try {
        console.log('üîç Cargando barberos para el filtro...');
        
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', SUPABASE_CONFIG.barberiaId)
            .eq('activo', true);
        
        if (error) {
            console.error('‚ùå Error RLS en tabla usuarios:', error);
            // Usar barberos de prueba si falla la consulta
            const barberosDefault = [
                { id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c', nombre: 'Administrador' },
                { id: '1a0242b8-bc7a-4e61-9e33-ac182996a950', nombre: 'Misho' }
            ];
            
            console.log('üîÑ Usando barberos por defecto');
            const select = document.getElementById('selectBarberoResumen');
            if (!select) return;
            
            barberosDefault.forEach(barbero => {
                const option = document.createElement('option');
                option.value = barbero.id;
                option.textContent = barbero.nombre;
                select.appendChild(option);
            });
            return;
        }
        
        console.log('‚úÖ Barberos cargados:', barberos);
        const select = document.getElementById('selectBarberoResumen');
        if (!select) return;
        
        barberos.forEach(barbero => {
            const option = document.createElement('option');
            option.value = barbero.id;
            option.textContent = barbero.nombre;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico cargando barberos:', error);
    }
}
        
        // ===============================
        // PESTA√ëA: SERVICIOS
        // ===============================
        async function loadServicios() {
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-list mr-2"></i>Servicios
                </h2>
                <div id="serviciosLista" class="mt-6">
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-600">Cargando servicios...</p>
                    </div>
                </div>
            `;

            try {
                const hoy = new Date().toISOString().split('T')[0];
                let query = supabase
                    .from('citas')
                    .select('*')
                    .eq('barberia_id', SUPABASE_CONFIG.barberiaId)
                    .eq('fecha', hoy);

                // Si es empleado, solo ver SUS servicios
                if (userRole === 'empleado') {
                    query = query.eq('realizado_por_id', currentUser.id);
                }

                const { data, error } = await query.order('codigo_diario', { ascending: false });

                if (error) throw error;

                const listaHTML = data && data.length > 0 ?
                    `<div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Barbero</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pago</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${data.map(s => `
                                    <tr>
                                        <td class="px-4 py-2 text-sm">#${s.codigo_diario}</td>
                                        <td class="px-4 py-2 text-sm">${s.realizado_por_nombre}</td>
                                        <td class="px-4 py-2 text-sm">${s.servicio_principal_nombre}</td>
                                        <td class="px-4 py-2 text-sm font-semibold">${s.monto_total.toLocaleString('es-CL')}</td>
                                        <td class="px-4 py-2 text-sm">${s.forma_pago}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`
                    : '<p class="text-gray-500">No hay servicios registrados hoy.</p>';

                document.getElementById('serviciosLista').innerHTML = listaHTML;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('serviciosLista').innerHTML =
                    '<p class="text-red-600">Error al cargar servicios</p>';
            }
        }
        
        // ===============================
        // PESTA√ëAS PENDIENTES
        // ===============================
        function loadGestionBarberos() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secci√≥n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-users mr-2"></i>Gesti√≥n de Barberos
                </h2>
                <p class="text-gray-600">Administra los barberos y adelantos...</p>
                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-yellow-800">Esta secci√≥n est√° en desarrollo.</p>
                </div>
            `;
        }
        
        function loadCierreCaja() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secci√≥n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-cash-register mr-2"></i>Cierre de Caja
                </h2>
                <p class="text-gray-600">Realiza el cierre de caja...</p>
                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-yellow-800">Esta secci√≥n est√° en desarrollo.</p>
                </div>
            `;
        }
        
        function loadEstadisticas() {
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = `
                    <p class="text-red-600">No tienes permisos para ver esta secci√≥n.</p>
                `;
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-chart-line mr-2"></i>Estad√≠sticas
                </h2>
                <p class="text-gray-600">Visualiza las estad√≠sticas del negocio...</p>
                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-yellow-800">Esta secci√≥n est√° en desarrollo.</p>
                </div>
            `;
        }
        
        // ===============================
        // LOGOUT
        // ===============================
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            location.reload();
        }
        
        // ===============================
        // VERIFICAR SESI√ìN AL CARGAR
        // ===============================
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userRole = localStorage.getItem('userRole');
                initializeApp();
            }
        });
    </script>
</body>
</html>
